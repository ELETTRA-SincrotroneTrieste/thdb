<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>THdb: THdb Qt and MySQL interface to a database.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">THdb<span id="projectnumber">&#160;1.x</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="classTHdb.html" title="A facade to the Historical Database management classes.">THdb</a> Qt and MySQL interface to a database. </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This class gives access to the database and allows registering <a class="el" href="classDbQueryInterface.html" title="Derive from this class to perform threaded queries on a database.">DbQueryInterface</a> objects, which are the means to query the database. </p>
<p ><a class="el" href="classTHdb.html" title="A facade to the Historical Database management classes.">THdb</a> is a library based on Qt that provides a programmer interface to easily execute queries on a separate thread and notify the user when the query execution terminates.</p>
<p >The main classes to keep in mind when using the library are </p><ul>
<li>
<a class="el" href="classTHdbBase.html" title="THdbBase is the base class to interact with or derive from to connect to a MySql database and execute...">THdbBase</a>: manages database connection and queries; </li>
<li>
<a class="el" href="classDbQueryInterface.html" title="Derive from this class to perform threaded queries on a database.">DbQueryInterface</a>: an interface that <em>must be reimplemented</em> in order to define the desired query and to be notified when the query execution ends and data are ready. </li>
<li>
<a class="el" href="classDbConnectionParams.html" title="this class contains the parameters that define a connection to a MySql database.">DbConnectionParams</a>: a class that contains the relevant parameters to open and setup a valid connection to a MySql database. </li>
</ul>
<dl class="section note"><dt>Note</dt><dd>These three classes should be enough for you to write an application to connect to a MySql database and to submit any type of query to it.</dd>
<dd>
Under the directory <b>example/thdbDemo</b> you'll find a simple example of an application that executes a query and shows the results on a QTableWidget. You may want to have a look at that application first. </dd></dl>
<h3>Historical Database (HDB) tailored classes</h3>
<p >The library provides a specific implementation of <a class="el" href="classTHdbBase.html" title="THdbBase is the base class to interact with or derive from to connect to a MySql database and execute...">THdbBase</a> which is called <a class="el" href="classTHdb.html" title="A facade to the Historical Database management classes.">THdb</a>, to which the reader is sent if interested to interact with that specific database.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="classTHdb.html" title="A facade to the Historical Database management classes.">THdb</a></dd></dl>
<h3>Framework description</h3>
<p >The main feature is that <b>the query is executed in another thread</b>. When data is ready, the <a class="el" href="classDbQueryInterface.html#a6b61df898472b74141437f43b7d5488c" title="Pure virtual method that must be implemented in your subclass.">DbQueryInterface::notify()</a> method is called and actually represents a callback. You must write your own notify() method in order to receive and organize the data collected from the database. </p>
<p >If subsequent queries are sent to the database via the <a class="el" href="classDbQueryInterface.html#a3613e6f361a95aa7d8bd166a4680eb0d" title="Triggers query execution on the Database thread.">DbQueryInterface::execute</a> method, they are <b>queued</b>, so that the <b>execution order is guaranteed</b>. Even a database switch, actuated by means of the <a class="el" href="classTHdbBase.html#a45720d6d9c0b3f9815ae1df12a82f333" title="sets up the connection to the database specified in the DbConnectionParams">THdbBase::setType</a> method, is enqueued just like any other database request, so that if you send subsequently</p>
<div class="fragment"><div class="line">query1-&gt;execute();</div>
<div class="line">query2-&gt;execute();</div>
<div class="line">thdbBaseObject-&gt;setType(<a class="code hl_enumvalue" href="classTHdbBase.html#a1aa63bc61023edf1a3703bc491bd905ea625a296dfb178124db24df088601ff9a">THdbBase::User</a>, <a class="code hl_class" href="classDbConnectionParams.html">DbConnectionParams</a>(...));</div>
<div class="line">query3-&gt;execute();</div>
<div class="ttc" id="aclassDbConnectionParams_html"><div class="ttname"><a href="classDbConnectionParams.html">DbConnectionParams</a></div><div class="ttdoc">this class contains the parameters that define a connection to a MySql database.</div><div class="ttdef"><b>Definition:</b> dbconnectionparams.h:20</div></div>
<div class="ttc" id="aclassTHdbBase_html_a1aa63bc61023edf1a3703bc491bd905ea625a296dfb178124db24df088601ff9a"><div class="ttname"><a href="classTHdbBase.html#a1aa63bc61023edf1a3703bc491bd905ea625a296dfb178124db24df088601ff9a">THdbBase::User</a></div><div class="ttdeci">@ User</div><div class="ttdef"><b>Definition:</b> thdbbase.h:49</div></div>
</div><!-- fragment --><p >then query1 and query2 are executed, in order, then another connection is opened to the database specified in <a class="el" href="classDbConnectionParams.html" title="this class contains the parameters that define a connection to a MySql database.">DbConnectionParams</a> and query3 is sent to the new database. </p>
<h2>Demo example</h2>
<p >Under the directory <b>example/thdbDemo</b> you'll find a simple example of an application that executes a query and shows the results on a QTableWidget. The query is executed in the database thread and the table is populated on data available notification. Database messages are used to display the success or failure of each phase of the database interaction. You may want to have a look at the example as starting point. </p>
<h3>Example</h3>
<p >As an example, suppose we have to connect to a database whose schema name is <em>snap</em> and we have to retrieve a list of <em>contexts</em> by means of a simple query.</p>
<dl class="section user"><dt>Implementation of a DbQueryInterface class</dt><dd></dd></dl>
<p>We must derive from <a class="el" href="classDbQueryInterface.html" title="Derive from this class to perform threaded queries on a database.">DbQueryInterface</a> and implement the two pure virtual methods </p><ul>
<li>
QString query(unsigned id) const; </li>
<li>
void notify(const QSqlQuery&amp;, const int eventId); </li>
</ul>
<p>The query() method is called by the database thread when it's time to execute the query, normally when the <a class="el" href="classDbQueryInterface.html#a3613e6f361a95aa7d8bd166a4680eb0d" title="Triggers query execution on the Database thread.">DbQueryInterface::execute()</a> method is invoked. <br  />
 The notify() method is invoked when the query is executed and the query result is passed as parameter, together with an <b>eventId</b> integer identifying the query id with which the execute was called. <br  />
 You might not need to specify a query id when calling execute(), and in fact in that case it defaults to -1. Yet, since the query is executed in another thread and you may want to queue more than one query at once, on result notification you may be interested in recognizing the query your result comes from. </p>
<div class="fragment"><div class="line"><span class="preprocessor"> #include &lt;DbQueryInterface&gt;</span></div>
<div class="line"><span class="keyword">class </span>CtxListQuery : <span class="keyword">public</span> <a class="code hl_class" href="classDbQueryInterface.html">DbQueryInterface</a></div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="comment">// the class constructor</span></div>
<div class="line">    CtxListQuery(QObject *parent = NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// the notify method, must be reimplemented because pure virtual</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="classDbQueryInterface.html#a6b61df898472b74141437f43b7d5488c">notify</a>(<span class="keyword">const</span> QSqlQuery&amp;, <span class="keyword">const</span> <span class="keywordtype">int</span> eventId);</div>
<div class="line">    <span class="comment">// this is normally not reimplemented, but you may want to do something</span></div>
<div class="line">    <span class="comment">// before executing the query</span></div>
<div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code hl_function" href="classDbQueryInterface.html#a3613e6f361a95aa7d8bd166a4680eb0d">execute</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span> = -1);</div>
<div class="line">    <span class="comment">// simply must return the query as string.</span></div>
<div class="line">    <span class="keyword">virtual</span> QString <a class="code hl_function" href="classDbQueryInterface.html#a8d6b023d6bae49f4176d5392e13131d3">query</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>) <span class="keyword">const</span>;</div>
<div class="line"> </div>
<div class="line">signals:</div>
<div class="line">    <span class="comment">// this signal is emitted by my CtxListQuery class when data is ready.</span></div>
<div class="line">    <span class="comment">// Inside notify(), query results are extracted and placed in a list</span></div>
<div class="line">    <span class="comment">// of ContextData objects.</span></div>
<div class="line">    <span class="comment">// It is not relevant for this purpose to know what ContextData is like,</span></div>
<div class="line">    <span class="comment">// anyway the class definition is reported below.</span></div>
<div class="line">    <span class="keywordtype">void</span> listReady(<span class="keyword">const</span> QList&lt;ContextData&gt;&amp;);</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">// class ContextData: contains a bunch of strings and an integer</span></div>
<div class="line"><span class="preprocessor">#include &lt;QString&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>ContextData</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    ContextData();</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">short</span> id;</div>
<div class="line">    QString time;</div>
<div class="line">    QString name, author, reason, description;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="ttc" id="aclassDbQueryInterface_html"><div class="ttname"><a href="classDbQueryInterface.html">DbQueryInterface</a></div><div class="ttdoc">Derive from this class to perform threaded queries on a database.</div><div class="ttdef"><b>Definition:</b> dbqueryinterface.h:62</div></div>
<div class="ttc" id="aclassDbQueryInterface_html_a3613e6f361a95aa7d8bd166a4680eb0d"><div class="ttname"><a href="classDbQueryInterface.html#a3613e6f361a95aa7d8bd166a4680eb0d">DbQueryInterface::execute</a></div><div class="ttdeci">virtual void execute(int id=-1)</div><div class="ttdoc">Triggers query execution on the Database thread.</div></div>
<div class="ttc" id="aclassDbQueryInterface_html_a6b61df898472b74141437f43b7d5488c"><div class="ttname"><a href="classDbQueryInterface.html#a6b61df898472b74141437f43b7d5488c">DbQueryInterface::notify</a></div><div class="ttdeci">virtual void notify(const QSqlQuery &amp;queryResult, const int eventId)=0</div><div class="ttdoc">Pure virtual method that must be implemented in your subclass.</div></div>
<div class="ttc" id="aclassDbQueryInterface_html_a8d6b023d6bae49f4176d5392e13131d3"><div class="ttname"><a href="classDbQueryInterface.html#a8d6b023d6bae49f4176d5392e13131d3">DbQueryInterface::query</a></div><div class="ttdeci">virtual QString query(int id) const =0</div><div class="ttdoc">Returns the QString representing the query to be executed.</div></div>
</div><!-- fragment --><h3>Implementing the CtxListQuery class</h3>
<p >The implementation of the CtxListQuery class is very simple</p>
<dl class="section user"><dt>CtxListQuery implementation</dt><dd><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;ctxlistquery.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QSqlQuery&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QSqlRecord&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;QVariant&gt;</span></div>
<div class="line"> </div>
<div class="line">CtxListQuery::CtxListQuery(QObject *parent) : <a class="code hl_class" href="classDbQueryInterface.html">DbQueryInterface</a>(parent)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> CtxListQuery::notify(<span class="keyword">const</span> QSqlQuery&amp; constQuery, <span class="keyword">const</span> <span class="keywordtype">int</span> eventId)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// list of data to fill in</span></div>
<div class="line">    QList&lt;ContextData&gt; ctxDataList;</div>
<div class="line">    QSqlQuery q(constQuery);</div>
<div class="line">    <span class="comment">// in this case the query contains 6 fields</span></div>
<div class="line">    <span class="keywordflow">while</span>(q.next() &amp;&amp; q.record().count() == 6)</div>
<div class="line">    {</div>
<div class="line">        ContextData cd;</div>
<div class="line">        <span class="comment">// use QSqlRecord and QSqlQuery methods to extract</span></div>
<div class="line">        <span class="comment">// data from the query</span></div>
<div class="line">        cd.id = q.value(0).toInt();</div>
<div class="line">        cd.time = q.value(1).toString();</div>
<div class="line">        cd.name = q.value(2).toString();</div>
<div class="line">        cd.author = q.value(3).toString();</div>
<div class="line">        cd.reason = q.value(4).toString();</div>
<div class="line">        cd.description = q.value(5).toString();</div>
<div class="line">        ctxDataList &lt;&lt; cd;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// this was our signal to notify the result</span></div>
<div class="line">    emit listReady(ctxDataList);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> CtxListQuery::execute(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// simply call base implementation in this case</span></div>
<div class="line">    <a class="code hl_function" href="classDbQueryInterface.html#a3613e6f361a95aa7d8bd166a4680eb0d">DbQueryInterface::execute</a>(<span class="keywordtype">id</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">QString CtxListQuery::query(<span class="keywordtype">unsigned</span> <span class="keywordtype">id</span>)<span class="keyword"> const</span></div>
<div class="line"><span class="keyword"></span>{</div>
<div class="line">    <span class="comment">// create our sql query and return it as a QString</span></div>
<div class="line">    QString q = <span class="stringliteral">&quot;SELECT * from context&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> q;</div>
<div class="line">}</div>
</div><!-- fragment --></dd></dl>
<h3>Connecting to the database and executing the query </h3>
<p >A <a class="el" href="classTHdbBase.html" title="THdbBase is the base class to interact with or derive from to connect to a MySql database and execute...">THdbBase</a> object (or a derived class) must be created. Then you must register your CtxListQuery via the <a class="el" href="classTHdbBase.html#a5a3e96123fd4d5a84799b48d6536c4d1" title="adds the dbQuery to the list of queries managed by THdb.">THdbBase::registerDbQuery</a> method</p>
<dl class="section user"><dt>Database connection and query execution</dt><dd><div class="fragment"><div class="line">CtxListQuery *ctxListQuery = <span class="keyword">new</span> CtxListQuery(<span class="keyword">this</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// use the listReadySignal to obtain query results when the</span></div>
<div class="line"><span class="comment">// query has been executed</span></div>
<div class="line">connect(ctxListQuery, SIGNAL(listReady(<span class="keyword">const</span> QList&lt;ContextData&gt;&amp;)), <span class="keyword">this</span>,</div>
<div class="line">    SLOT(contextListReady(<span class="keyword">const</span> QList&lt;ContextData&gt;&amp;)));</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classTHdbBase.html">THdbBase</a> *thdbBase = <span class="keyword">new</span> <a class="code hl_class" href="classTHdbBase.html">THdbBase</a>(<span class="keyword">this</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// registerDbQuery is called with a string and the object to register</span></div>
<div class="line"><span class="comment">// the string is useful to obtain the ctxListQuery back with the</span></div>
<div class="line"><span class="comment">// THdbBase::dbQueryInterface method</span></div>
<div class="line">thdbBase-&gt;<a class="code hl_function" href="classTHdbBase.html#a5a3e96123fd4d5a84799b48d6536c4d1">registerDbQuery</a>(<span class="stringliteral">&quot;CtxListQuery&quot;</span>, ctxListQuery);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// now you are ready to execute the query by calling the execute method</span></div>
<div class="line"><span class="comment">// on the ctxListQuery. You can also connect the clicked signal of a push</span></div>
<div class="line"><span class="comment">// button to the execute slot of the ctxListQuery object, like this</span></div>
<div class="line">connect(pushButtonExecQuery, SIGNAL(clicked()), ctxListQuery, SLOT(execute()));</div>
<div class="ttc" id="aclassTHdbBase_html"><div class="ttname"><a href="classTHdbBase.html">THdbBase</a></div><div class="ttdoc">THdbBase is the base class to interact with or derive from to connect to a MySql database and execute...</div><div class="ttdef"><b>Definition:</b> thdbbase.h:35</div></div>
<div class="ttc" id="aclassTHdbBase_html_a5a3e96123fd4d5a84799b48d6536c4d1"><div class="ttname"><a href="classTHdbBase.html#a5a3e96123fd4d5a84799b48d6536c4d1">THdbBase::registerDbQuery</a></div><div class="ttdeci">void registerDbQuery(const QString &amp;name, DbQueryInterface *dbQuery)</div><div class="ttdoc">adds the dbQuery to the list of queries managed by THdb.</div></div>
</div><!-- fragment --></dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
